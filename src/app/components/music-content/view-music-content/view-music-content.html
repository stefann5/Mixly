<div class="p-4">
  <!-- Header -->
  <div class="flex justify-content-between align-items-center mb-4">
    <h1 class="text-3xl font-bold m-0">Music Content</h1>
    <p-button
      label="Create Song"
      icon="pi pi-plus"
      *ngIf="isAdmin()"
      (onClick)="navigateToCreate()"
    ></p-button>
  </div>

  <!-- Loading State -->
  <div
    class="flex justify-content-center align-items-center"
    style="min-height: 200px"
    *ngIf="isLoading && musicContent.length === 0"
  >
    <p-progressSpinner strokeWidth="3"></p-progressSpinner>
  </div>

  <!-- Error State -->
  <p-message
    *ngIf="errorMessage && !isLoading"
    severity="error"
    [text]="errorMessage"
    styleClass="w-full mb-4"
  ></p-message>

  <!-- Empty State -->
  <p-card
    *ngIf="!isLoading && musicContent.length === 0 && !errorMessage"
    styleClass="text-center"
  >
    <i class="pi pi-users text-6xl text-300 mb-3 block"></i>
    <h3 class="text-xl mb-2">No Music Content Found</h3>
    <p class="text-500 mb-4">No songs have been added yet.</p>
    <p-button
      label="Create First Music Content"
      icon="pi pi-plus"
      (onClick)="navigateToCreate()"
    ></p-button>
  </p-card>

  <!-- Music Contents Grid -->
  <div class="grid" *ngIf="!isLoading && musicContent.length > 0">
    <div
      class="col-12 md:col-6 lg:col-4 xl:col-3"
      *ngFor="let content of musicContent"
    >
      <p-card
        styleClass="h-full shadow-2 hover:shadow-4 transition-all transition-duration-200"
      >
      <div class="text-center mb-3 relative">
        <img [src]="getCoverImageUrl(content)"
             [alt]="content.title + ' cover'"
             class="w-full h-12rem object-fit-cover border-round"/>
        <div class="absolute inset-0 flex align-items-center justify-content-center bg-black-alpha-50 opacity-0 hover:opacity-100 trasition-all transition-duration-200 border-round">
            <p-button [icon]="isCurrentlyPlaying(content.contentId) ? 'pi pi-pause' : 'pi pi-play'"
                      severity="contrast"
                      [rounded]="true"
                      size="large"
                      (onClick)="togglePlayback(content)">
            </p-button>
        </div>
      </div>
        <!-- Song Name -->
        <h3 class="text-xl font-bold text-center mb-3 text-900">
          {{ content.title }}
        </h3>

        <!-- Artist & Album -->
        <div class="text-center mb-3 text-600">
          <div *ngIf="content.artistName" class="mb-1">
            <i class="pi pi-user mr-1"></i>
            {{ content.artistName }}
          </div>
          <div>
            <i class="pi pi-disc mr-1"></i>
            {{ getAlbum(content) }}
          </div>
        </div>

        <!-- Genre using Chips -->
        <h5 class="mb-4">
          {{content.genre}}
        </h5>

        <p-divider></p-divider>

        <!-- Actions -->
        <div class="flex gap-2 justify-content-center mt-3">
          <p-button
            [icon]="isCurrentlyPlaying(content.contentId) ? 'pi pi-pause' : 'pi pi-play'"
            [severity]="isCurrentlyPlaying(content.contentId) ? 'danger' : 'success'"
            size="small"
            (onClick)="togglePlayback(content)"
            [pTooltip]="isCurrentlyPlaying(content.contentId) ? 'Pause' : 'Play'"
            tooltipPosition="top"
          ></p-button>
          <p-button
            icon="pi pi-info-circle"
            severity="info"
            size="small"
            (onClick)="viewSongDetails(content)"
            pTooltip="View Details"
            tooltipPosition="top"></p-button>
          <p-button
            icon="pi pi-pencil"
            severity="danger"
            size="small"
            (onClick)="editSong(content)"
            *ngIf="isAdmin()"
            pTooltip="Edit Song"
            tooltipPosition="top"
          ></p-button>

          <p-button
            icon="pi pi-trash"
            severity="danger"
            size="small"
            (onClick)="deleteSong(content)"
            *ngIf="isAdmin()"
            pTooltip="Delete Song"
            tooltipPosition="top"
          ></p-button>
        </div>
      </p-card>
    </div>
  </div>

  <!-- Load More Button -->
  <div class="text-center mt-4" *ngIf="hasMore && !isLoading">
    <p-button
      label="Load More Songs"
      icon="pi pi-chevron-down"
      severity="secondary"
      (onClick)="loadMoreMusicContent()"
      [loading]="isLoadingMore"
    ></p-button>
  </div>
</div>

<!-- Enhanced Song Details Dialog with Transcription -->
<p-dialog
    header="Song Details"
    [(visible)]="displayDialog"
    [modal]="true"
    [style]="{ width: '80vw', minWidth: '320px', height: '80vh' }"
    [draggable]="false"
    [resizable]="true">
    
    <div *ngIf="selectedContent">
        <!-- Song Header -->
        <div class="flex gap-3 align-items-start mb-4">
            <img [src]="getCoverImageUrl(selectedContent)"
                 [alt]="selectedContent.title + ' cover'"
                 class="w-8rem h-8rem object-fit-cover border-round flex-shrink-0"/>
            <div class="flex-1">
                <h2 class="text-2xl font-bold mb-2 text-900">{{ selectedContent.title }}</h2>
                <div class="mb-2"><strong>Artist:</strong> {{selectedContent.artistName}}</div>
                <div class="mb-2"><strong>Album:</strong> {{getAlbum(selectedContent)}}</div>
                <div class="mb-2"><strong>Genre:</strong> {{selectedContent.genre}}</div>
            </div>
        </div>

        <!-- Playback Controls -->
        <div class="text-center mb-4">
            <p-button
                [label]="isCurrentlyPlaying(selectedContent.contentId) ? 'Pause' : 'Play Song'"
                [icon]="isCurrentlyPlaying(selectedContent.contentId) ? 'pi pi-pause' : 'pi pi-play'"
                [severity]="isCurrentlyPlaying(selectedContent.contentId) ? 'danger' : 'success'"
                (onClick)="togglePlayback(selectedContent)"
                size="large"
            ></p-button>
        </div>

        <p-divider></p-divider>

        <!-- Tabbed Content -->
        <p-tabs value="0">
           <p-tablist>
              <p-tab value="0">Song Info</p-tab>
              <p-tab value="1">Transcription</p-tab>
          </p-tablist>
          <p-tabpanels>
            <!-- Song Information Tab -->
            <p-tabpanel header="Song Info" leftIcon="pi pi-info-circle" value="0">
                <div class="p-3">
                    <div class="grid">
                        <div class="col-12 md:col-6">
                            <h4>File Information</h4>
                            <p><strong>Filename:</strong> {{selectedContent.filename}}</p>
                            <p><strong>File Type:</strong> {{selectedContent.fileType}}</p>
                            <p><strong>File Size:</strong> {{(selectedContent.fileSize / (1024 * 1024)).toFixed(2)}} MB</p>
                        </div>
                        <div class="col-12 md:col-6">
                            <h4>Dates</h4>
                            <p><strong>Created:</strong> {{selectedContent.createdAt | date:'medium'}}</p>
                            <p><strong>Modified:</strong> {{selectedContent.lastModified | date:'medium'}}</p>
                        </div>
                    </div>
                </div>
            </p-tabpanel>

            <!-- Transcription Tab -->
            <p-tabpanel header="Transcription" leftIcon="pi pi-file-word" value="1">
                <div class="p-3">
                    <!-- Loading State -->
                    <div *ngIf="isTranscriptionLoading(selectedContent.contentId)" 
                         class="flex justify-content-center align-items-center p-5">
                        <p-progressSpinner strokeWidth="3"></p-progressSpinner>
                        <span class="ml-3">Loading transcription...</span>
                    </div>

                    <!-- Error State -->
                    <div *ngIf="getTranscriptionError(selectedContent.contentId)" 
                         class="text-center p-5">
                        <i class="pi pi-exclamation-triangle text-4xl text-orange-500 mb-3"></i>
                        <h4>Failed to Load Transcription</h4>
                        <p class="text-600 mb-3">{{getTranscriptionError(selectedContent.contentId)}}</p>
                        <p-button 
                            label="Retry" 
                            icon="pi pi-refresh" 
                            severity="secondary"
                            (onClick)="retryTranscription(selectedContent.contentId)">
                        </p-button>
                    </div>

                    <!-- Not Found State -->
                    <div *ngIf="getTranscriptionState(selectedContent.contentId).data?.status === 'NOT_FOUND'" 
                         class="text-center p-5">
                        <i class="pi pi-file-excel text-4xl text-500 mb-3"></i>
                        <h4>No Transcription Available</h4>
                        <p class="text-600">This song doesn't have a transcription yet.</p>
                    </div>

                    <!-- Processing State -->
                    <div *ngIf="getTranscriptionState(selectedContent.contentId).data?.status === 'PROCESSING'" 
                         class="text-center p-5">
                        <i class="pi pi-clock text-4xl text-blue-500 mb-3"></i>
                        <h4>Transcription in Progress</h4>
                        <p class="text-600">The transcription is being processed. Please check back later.</p>
                        <p-button 
                            label="Refresh" 
                            icon="pi pi-refresh" 
                            severity="secondary"
                            (onClick)="retryTranscription(selectedContent.contentId)">
                        </p-button>
                    </div>

                    <!-- Failed State -->
                    <div *ngIf="getTranscriptionState(selectedContent.contentId).data?.status === 'FAILED'" 
                         class="text-center p-5">
                        <i class="pi pi-times-circle text-4xl text-red-500 mb-3"></i>
                        <h4>Transcription Failed</h4>
                        <p class="text-600">
                            {{getTranscriptionState(selectedContent.contentId).data?.errorMessage || 'The transcription process failed.'}}
                        </p>
                    </div>

                    <!-- Completed Transcription -->
                    <div *ngIf="hasTranscription(selectedContent.contentId)">
                        <!-- Transcription Stats -->
                        <div class="flex gap-4 mb-4 p-3 bg-blue-50 border-round">
                            <div class="text-center">
                                <div class="font-bold">{{getTranscriptionState(selectedContent.contentId).data?.wordCount || 0}}</div>
                                <div class="text-sm text-600">Words</div>
                            </div>
                            <div class="text-center">
                                <div class="font-bold">{{((getTranscriptionState(selectedContent.contentId).data?.confidence || 0) * 100).toFixed(1)}}%</div>
                                <div class="text-sm text-600">Confidence</div>
                            </div>
                            <div class="text-center" *ngIf="getTranscriptionState(selectedContent.contentId).data?.completedAt">
                                <div class="font-bold">{{getTranscriptionState(selectedContent.contentId).data?.completedAt | date:'short'}}</div>
                                <div class="text-sm text-600">Completed</div>
                            </div>
                        </div>

                        <!-- Interactive Transcription -->
                        <div class="transcription-wrapper" 
                             style="max-height: 400px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 6px; padding: 1rem;">
                            <div [innerHTML]="getTranscriptionHtml(selectedContent.contentId)"></div>
                        </div>

                        <!-- Instructions -->
                        <p-message severity="info" styleClass="mt-3">
                            <span>Click on words to see timing information. Segments highlight based on confidence levels.</span>
                        </p-message>
                    </div>
                </div>
            </p-tabpanel>
            </p-tabpanels>
        </p-tabs>
    </div>
</p-dialog>

<p-toast></p-toast>