<div class="p-4">
  <!-- Header -->
  <div class="flex justify-content-between align-items-center mb-4">
    <h1 class="text-3xl font-bold m-0">Music Content</h1>
    <p-button
      label="Create Song"
      icon="pi pi-plus"
      *ngIf="isAdmin()"
      (onClick)="navigateToCreate()"
    ></p-button>
  </div>

  <!-- Loading State -->
  <div
    class="flex justify-content-center align-items-center"
    style="min-height: 200px"
    *ngIf="isLoading && musicContent.length === 0"
  >
    <p-progressSpinner strokeWidth="3"></p-progressSpinner>
  </div>

  <!-- Error State -->
  <p-message
    *ngIf="errorMessage && !isLoading"
    severity="error"
    [text]="errorMessage"
    styleClass="w-full mb-4"
  ></p-message>

  <!-- Empty State -->
  <p-card
    *ngIf="!isLoading && musicContent.length === 0 && !errorMessage"
    styleClass="text-center"
  >
    <i class="pi pi-users text-6xl text-300 mb-3 block"></i>
    <h3 class="text-xl mb-2">No Music Content Found</h3>
    <p class="text-500 mb-4">No songs have been added yet.</p>
    <p-button
      label="Create First Music Content"
      icon="pi pi-plus"
      (onClick)="navigateToCreate()"
    ></p-button>
  </p-card>

  <!-- Music Contents Grid -->
  <div class="grid" *ngIf="!isLoading && musicContent.length > 0">
    <div
      class="col-12 md:col-6 lg:col-4 xl:col-3"
      *ngFor="let content of musicContent"
    >
      <p-card
        styleClass="h-full shadow-2 hover:shadow-4 transition-all transition-duration-200"
      >
        <div class="text-center mb-3 relative">
          <img
            [src]="getCoverImageUrl(content)"
            [alt]="content.title + ' cover'"
            class="w-full h-12rem object-fit-cover border-round"
          />
          <div
            class="absolute inset-0 flex align-items-center justify-content-center bg-black-alpha-50 opacity-0 hover:opacity-100 trasition-all transition-duration-200 border-round"
          >
            <p-button
              [icon]="
                isCurrentlyPlaying(content.contentId)
                  ? 'pi pi-pause'
                  : 'pi pi-play'
              "
              severity="contrast"
              [rounded]="true"
              size="large"
              (onClick)="togglePlayback(content)"
            >
            </p-button>
          </div>
        </div>
        <!-- Song Name -->
        <h3 class="text-xl font-bold text-center mb-3 text-900">
          {{ content.title }}
        </h3>

        <!-- Artist & Album -->
        <div class="text-center mb-3 text-600">
          <div *ngIf="content.artistName" class="mb-1">
            <i class="pi pi-user mr-1"></i>
            {{ content.artistName }}
          </div>
          <div>
            <i class="pi pi-disc mr-1"></i>
            {{ getAlbum(content) }}
          </div>
        </div>

        <!-- Genre using Chips -->
        <h5 class="mb-4">
          {{ content.genre }}
        </h5>

        <p-divider></p-divider>

        <!-- Actions -->
        <div class="flex gap-2 justify-content-center mt-3">
          <p-button
            [icon]="
              isCurrentlyPlaying(content.contentId)
                ? 'pi pi-pause'
                : 'pi pi-play'
            "
            [severity]="
              isCurrentlyPlaying(content.contentId) ? 'danger' : 'success'
            "
            size="small"
            (onClick)="togglePlayback(content)"
            [pTooltip]="
              isCurrentlyPlaying(content.contentId) ? 'Pause' : 'Play'
            "
            tooltipPosition="top"
          ></p-button>
          <p-button
            icon="pi pi-info-circle"
            severity="info"
            size="small"
            (onClick)="viewSongDetails(content)"
            pTooltip="View Details"
            tooltipPosition="top"
          ></p-button>
          <p-button
            icon="pi pi-pencil"
            severity="danger"
            size="small"
            (onClick)="editSong(content)"
            *ngIf="isAdmin()"
            pTooltip="Edit Song"
            tooltipPosition="top"
          ></p-button>

          <p-button
            icon="pi pi-trash"
            severity="danger"
            size="small"
            (onClick)="deleteSong(content)"
            *ngIf="isAdmin()"
            pTooltip="Delete Song"
            tooltipPosition="top"
          ></p-button>
          <p-button
            icon="pi pi-star"
            severity="info"
            size="small"
            (onClick)="openRateDialog(content)"
            pTooltip="Rate"
            [disabled]="isSongRated(content.contentId)"
            tooltipPosition="top"
          ></p-button>
          <p-button
            icon="pi pi-bell"
            severity="info"
            size="small"
            (onClick)="openSubscribeDialog(content)"
            pTooltip="Subscribe"
            tooltipPosition="top"
          ></p-button>
        </div>
      </p-card>
    </div>
  </div>

  <!-- Load More Button -->
  <div class="text-center mt-4" *ngIf="hasMore && !isLoading">
    <p-button
      label="Load More Songs"
      icon="pi pi-chevron-down"
      severity="secondary"
      (onClick)="loadMoreMusicContent()"
      [loading]="isLoadingMore"
    ></p-button>
  </div>
</div>
<p-dialog
  header="Song Details"
  [(visible)]="displayDialog"
  [modal]="true"
  [style]="{ width: '50vw', minWidth: '300px' }"
  [draggable]="false"
  [resizable]="false"
>
  <div *ngIf="selectedContent" class="flex flex-column gap-3">
    <div class="flex gap-3 align-items-start">
      <img
        [src]="getCoverImageUrl(selectedContent)"
        [alt]="selectedContent.title + ' cover'"
        class="w-8rem h-8rem object-fit-cover border-round flex-shrink-0"
      />
      <div class="flex-1">
        <h2 class="text-2xl font-bold mb-2 text-900">
          {{ selectedContent.title }}
        </h2>
        <div class="mb-2">
          <strong>Artist</strong> {{ selectedContent.artistName }}
        </div>
      </div>
      <div class="mb-2">
        <strong>Album: </strong> {{ getAlbum(selectedContent) }}
      </div>
      <div class="mb-2">
        <strong>Genre: </strong> {{ selectedContent.genre }}
      </div>
    </div>

    <p-divider></p-divider>
    <div class="text-center">
      <p-button
        [label]="
          isCurrentlyPlaying(selectedContent.contentId) ? 'Pause' : 'Play Song'
        "
        [icon]="
          isCurrentlyPlaying(selectedContent.contentId)
            ? 'pi pi-pause'
            : 'pi pi-play'
        "
        [severity]="
          isCurrentlyPlaying(selectedContent.contentId) ? 'danger' : 'success'
        "
        (onClick)="togglePlayback(selectedContent)"
        size="large"
      ></p-button>
      <p-button
        styleClass="ml-3"
        label="Ratings"
        icon="pi pi-star"
        (onClick)="showRatings(selectedContent.contentId)"
        size="large"
      ></p-button>
    </div>
  </div>
</p-dialog>
<p-toast></p-toast>

<!-- Rate Dialog -->
<p-dialog
  header="Rate Content"
  [(visible)]="rateDialogVisible"
  [modal]="true"
  [closable]="false"
  [style]="{ width: '25rem' }"
>
  <div class="flex flex-col gap-3">
    <p-rating [(ngModel)]="selectedRating" stars="5"></p-rating>
    <div class="flex justify-end gap-2">
      <p-button
        label="Cancel"
        severity="secondary"
        (onClick)="rateDialogVisible = false"
      ></p-button>
      <p-button label="Submit" (onClick)="submitRating()"></p-button>
    </div>
  </div>
</p-dialog>

<!-- Subscribe Dialog - izmene za disable opcije -->
<p-dialog
  header="Subscribe"
  [(visible)]="subscribeDialogVisible"
  [modal]="true"
  [closable]="false"
  [style]="{ width: '25rem' }"
>
  <div class="flex flex-col gap-3">
    <!-- Artist opcija -->
    <div class="flex items-center gap-2">
      <p-radioButton
        name="subscribeType"
        value="ARTIST"
        [(ngModel)]="selectedSubscribeType"
        inputId="artist"
        [disabled]="
          currentContent && isArtistSubscribed(currentContent.artistId)
        "
      >
      </p-radioButton>
      <label
        for="artist"
        [class.text-gray-400]="
          currentContent && isArtistSubscribed(currentContent.artistId)
        "
      >
        Artist
        {{
          currentContent && isArtistSubscribed(currentContent.artistId)
            ? "(Already subscribed)"
            : ""
        }}
      </label>
    </div>

    <!-- Genre opcija -->
    <div class="flex items-center gap-2">
      <p-radioButton
        name="subscribeType"
        value="GENRE"
        [(ngModel)]="selectedSubscribeType"
        inputId="genre"
        [disabled]="currentContent && isGenreSubscribed(currentContent.genre)"
      >
      </p-radioButton>
      <label
        for="genre"
        [class.text-gray-400]="
          currentContent && isGenreSubscribed(currentContent.genre)
        "
      >
        Genre
        {{
          currentContent && isGenreSubscribed(currentContent.genre)
            ? "(Already subscribed)"
            : ""
        }}
      </label>
    </div>

    <!-- Poruka ako su obe opcije disabled -->
    <div
      *ngIf="
        currentContent &&
        isArtistSubscribed(currentContent.artistId) &&
        isGenreSubscribed(currentContent.genre)
      "
      class="text-center text-gray-500 text-sm"
    >
      You are already subscribed to both artist and genre.
    </div>

    <div class="flex justify-end gap-2">
      <p-button
        label="Cancel"
        severity="secondary"
        (onClick)="subscribeDialogVisible = false"
      ></p-button>
      <p-button
        label="Submit"
        [disabled]="
          !selectedSubscribeType ||
          (currentContent &&
            isArtistSubscribed(currentContent.artistId) &&
            isGenreSubscribed(currentContent.genre))
        "
        (onClick)="submitSubscribe()"
      >
      </p-button>
    </div>
  </div>
</p-dialog>

<p-dialog
  header="Song Ratings"
  [(visible)]="ratingsDialogVisible"
  [modal]="true"
  [closable]="true"
  [style]="{ width: '35rem', maxHeight: '70vh' }"
>
  <!-- Loading spinner -->
  <div *ngIf="loadingRatings" class="flex justify-center items-center py-8">
    <p-progressSpinner strokeWidth="4"></p-progressSpinner>
  </div>

  <!-- Ratings list -->
  <div *ngIf="!loadingRatings" class="ratings-container">
    <!-- Empty state -->
    <div
      *ngIf="selectedContentRatings.length === 0"
      class="text-center py-8 text-gray-500"
    >
      <i class="pi pi-star text-4xl mb-3"></i>
      <p>No ratings yet for this song.</p>
    </div>

    <!-- Ratings list -->
    <div
      *ngIf="selectedContentRatings.length > 0"
      class="space-y-3 max-h-96 overflow-y-auto"
    >
      <!-- Rating item -->
      <div
        *ngFor="let rating of selectedContentRatings"
        class="flex items-center justify-between p-3 border rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors"
      >
        <!-- Username -->
        <div class="flex items-center gap-3">
          <!-- Zameni postojeÄ‡i div sa ovim: -->
          <div
            class="w-8 h-8 rounded-full flex items-center justify-center text-gray-800"
          >
            <i class="pi pi-user text-sm"></i>
          </div>
          <span class="font-medium text-gray-800 mr-3">  {{ rating.username }} </span>
        </div>

        <!-- Stars -->
        <div class="flex items-center gap-1">
          <i
            *ngFor="let filled of getStarsArray(rating.stars); let i = index"
            class="pi text-lg"
            [class.pi-star-fill]="filled"
            [class.pi-star]="!filled"
            [class.text-yellow-400]="filled"
            [class.text-gray-300]="!filled"
          >
          </i>
          <span class="ml-2 text-sm text-gray-600">({{ rating.stars }}/5)</span>
        </div>
      </div>
    </div>

    <!-- Summary -->
    <div *ngIf="selectedContentRatings.length > 0" class="mt-4 pt-4 border-t">
      <div class="text-sm text-gray-600">
        <div>Total ratings: {{ selectedContentRatings.length }}</div>
        <div>Average: {{ getAverageRating() }}</div>
      </div>
    </div>
  </div>

  <!-- Dialog footer -->
  <div class="flex justify-end pt-4">
    <p-button
      label="Close"
      severity="secondary"
      (onClick)="ratingsDialogVisible = false"
    >
    </p-button>
  </div>
</p-dialog>
